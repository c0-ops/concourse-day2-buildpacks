groups:

- name: all
  jobs:
  - update-buildpacks-java
  - test-buildpack-java
  - update-buildpacks-go
  - test-buildpack-go
  - update-buildpacks-nodejs
  - test-buildpack-nodejs
  - notify-operator
  - update-buildpacks-prod

- name: update-buildpacks-java
  jobs:
  - update-buildpacks-java
  - test-buildpack-java
  - notify-operator
  - update-buildpacks-prod

- name: update-buildpacks-go
  jobs:
  - update-buildpacks-go
  - test-buildpack-go
  - notify-operator
  - update-buildpacks-prod

- name: update-buildpacks-nodejs
  jobs:
  - update-buildpacks-nodejs
  - test-buildpack-nodejs
  - notify-operator
  - update-buildpacks-prod


resource_types:

- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:

- name: concourse-day2-buildpacks
  type: git
  source:
    uri: https://github.com/c0-ops/concourse-day2-buildpacks.git
    branch: master

- name: java-buildpack-release
  type: bosh-io-release
  check_every: 2h
  source:
    repository: cloudfoundry/java-buildpack-release

- name: go-buildpack-release
  type: bosh-io-release
  check_every: 2h
  source:
    repository: cloudfoundry/go-buildpack-release

- name: nodejs-buildpack-release
  type: bosh-io-release
  check_every: 2h
  source:
    repository: cloudfoundry/go-buildpack-release


jobs:

- name: update-buildpacks-java
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
    - get: java-buildpack-release
      trigger: true
  - task: update-buildpacks
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: java-buildpack-release
      run:
        path: concourse-day2-buildpacks/ci/tasks/update/update-buildpacks.sh
      params:
        buildpack: "java_buildpack_offline"
        cf_api: {{cf_api}}
        cf_user: {{cf_user}}
        cf_password: {{cf_password}}

- name: test-buildpack-java
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
      passed: [update-buildpacks-java]
    - get: java-buildpack-release
      trigger: true
      passed: [update-buildpacks-java]
  - task: test-buildpack-java
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: java-buildpack-release

- name: update-buildpacks-go
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
    - get: go-buildpack-release
      trigger: true
  - task: update-buildpacks
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: go-buildpack-release
      run:
        path: concourse-day2-buildpacks/ci/tasks/update/update-buildpacks.sh
      params:
        buildpack: "go_buildpack"
        cf_api: {{cf_api}}
        cf_user: {{cf_user}}
        cf_password: {{cf_password}}

- name: test-buildpack-go
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
      passed: [update-buildpacks-go]
    - get: go-buildpack-release
      trigger: true
      passed: [update-buildpacks-go]
  - task: test-buildpack-go
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: go-buildpack-release

- name: update-buildpacks-nodejs
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
    - get: nodejs-buildpack-release
      trigger: true
  - task: update-buildpacks
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: nodejs-buildpack-release
      run:
        path: concourse-day2-buildpacks/ci/tasks/update/update-buildpacks.sh
      params:
        buildpack: "nodejs_buildpack"
        cf_api: {{cf_api}}
        cf_user: {{cf_user}}
        cf_password: {{cf_password}}

- name: test-buildpack-nodejs
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
  - aggregate:
    - get: concourse-day2-buildpacks
      trigger: false
      passed: [update-buildpacks-nodejs]
    - get: nodejs-buildpack-release
      trigger: true
      passed: [update-buildpacks-nodejs]
  - task: test-buildpack-nodejs
    config:
      platform: linux
      image: docker:///virtmerlin/c0-worker
      inputs:
        - name: concourse-day2-buildpacks
        - name: nodejs-buildpack-release

- name: notify-operator
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
    - aggregate:
      - get: java-buildpack-release
        trigger: true
        passed: [test-buildpack-java]
      - get: go-buildpack-release
        trigger: true
        passed: [test-buildpack-go]
      - get: nodejs-buildpack-release
        trigger: true
        passed: [test-buildpack-nodejs]

- name: update-buildpacks-prod
  serial: true
  max_in_flight: 1
  serial_groups: [full]
  plan:
    - aggregate:
      - get: java-buildpack-release
        trigger: true
        passed: [notify-operator]
      - get: go-buildpack-release
        trigger: true
        passed: [notify-operator]
      - get: nodejs-buildpack-release
        trigger: true
        passed: [notify-operator]
